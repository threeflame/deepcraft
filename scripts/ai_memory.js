// BP/scripts/ai_memory.js

/*
==========================================================================
 ğŸ§  AI CONTEXT MEMORY (DeepCraft Development Log)
 Version: 19.0 (Combat Log Fix & Partial Drop System Complete)
==========================================================================

## 1. Project Overview
- **Title**: DeepCraft
- **Concept**: Deepwoken-inspired PvPvE RPG (Hardcore / Stat Building).
- **Environment**: Minecraft BE Script API 1.13.0+
- **Library**: Chest-UI (Menu System).
- **GameRule Requirement**: `keepInventory` must be **TRUE**.

## 2. âš ï¸ Technical Constraints & Ban List (ä¿®æ­£æ™‚ãƒ»ä½¿ç”¨ç¦æ­¢äº‹é …)
1.  **[BANNED] `world.beforeEvents.entityHurt`**: å‹•ä½œä¸å®‰å®šã®ãŸã‚ä½¿ç”¨ç¦æ­¢ã€‚å…¨ã¦ `afterEvents` ã§å‡¦ç†ã™ã‚‹ã€‚
2.  **[BANNED] `world.beforeEvents.playerLeave` for Spawning**:
    * **ç†ç”±**: èª­ã¿å–ã‚Šå°‚ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ãŸã‚ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆã‚„ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå¤‰æ›´ãŒã§ããªã„ã€‚
    * **è§£æ±ºç­–**: `system.runInterval` ã§å¸¸æ™‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚Šã€`afterEvents.playerLeave` ã§ç”Ÿæˆã™ã‚‹ã€‚
3.  **[BANNED] `processLevelUp` Function Separation**:
    * **ç†ç”±**: å‡¦ç†ãŒåˆ†æ•£ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ºãƒ¬ã¦ãƒã‚°ã‚‹ã€‚
    * **è§£æ±ºç­–**: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†ã¯ `upgradeStat` å†…ã§ã‚¢ãƒˆãƒŸãƒƒã‚¯ï¼ˆä¸€æ‹¬ï¼‰ã«è¡Œã†ã€‚
4.  **[BANNED] Player Scaling**:
    * **ç†ç”±**: Hitbox Desyncï¼ˆåˆ¤å®šã‚ºãƒ¬ï¼‰ã®ä¸»åŸå› ã¨ãªã‚‹ãŸã‚ã€`player.json` ã‹ã‚‰ã‚¹ã‚±ãƒ¼ãƒ«é–¢é€£ã®å®šç¾©ã¯å…¨å‰Šé™¤æ¸ˆã¿ã€‚

5.  **[BANNED] `manifest.json` Direct Editing**:
    * **ç†ç”±**: Gemini Code Assistã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`manifest.json`ãªã©ï¼‰ã‚’ç›´æ¥ç·¨é›†ã§ãã¾ã›ã‚“ã€‚Script APIã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãªã©ã¯æ‰‹å‹•ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

6.  **[BANNED] `beforeEvents.chatSend` for Command Aliases**:
    * **ç†ç”±**: `manifest.json` ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ `@minecraft/server` v1.18.0 ã§ã¯ã€`chatSend` ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ« (`ev.cancel`) ãŒã§ãã¾ã›ã‚“ã€‚
    * **è§£æ±ºç­–**: ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã¯ã™ã¹ã¦ `/scriptevent deepcraft:<command>` å½¢å¼ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚`!` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹æ©Ÿèƒ½ã¯å®Ÿè£…ä¸å¯èƒ½ã§ã™ã€‚

## 3. ğŸ›¡ï¸ Critical Implementation Rules (åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ ã®æ­£è§£ãƒ­ã‚¸ãƒƒã‚¯)

### A. HP System (Virtual HP)
- **Vanilla HP**: `player.json` ã§ **200** (ãƒãƒ¼ãƒˆ100å€‹) ã«å›ºå®šã€‚
- **Damage Handling**: `entityHurt` ã®**å†’é ­**ã§ `resetToMax()` ã‚’å®Ÿè¡Œã—ã€ãƒãƒ‹ãƒ©ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å¸³æ¶ˆã—ã«ã™ã‚‹ã€‚
- **Virtual HP**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸Šã® `deepcraft:hp` ã‚’è¨ˆç®—çµæœã§æ¸›ç®—ã™ã‚‹ã€‚
- **Death**: ä»®æƒ³HP <= 0 ã§ `kill` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã€‚
- **Respawn**: `playerSpawn` æ™‚ã«ä»®æƒ³HPã‚’æœ€å¤§å€¤ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼ˆç„¡é™æ­»é˜²æ­¢ï¼‰ã€‚

### B. Level Up Logic
- **Atomic Update**: 
    - ãƒã‚¤ãƒ³ãƒˆåŠ ç®—å¾Œã« `if (next >= 15)` ã§åˆ†å²ã€‚
    - ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã¯ `invested_points` ã« **å¿…ãš `0` ã‚’ä¿å­˜**ã€‚
    - é€”ä¸­ãªã‚‰åŠ ç®—ã—ãŸå€¤ã‚’ä¿å­˜ã€‚
    - ã“ã‚Œã‚‰ã‚’1ã¤ã®é–¢æ•°å†…ã§è¡Œã†ã€‚

### C. Combat Mode & Anti-Combat Log
- **Trigger**: æ”»æ’ƒ/è¢«å¼¾æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼(20s)ã‚»ãƒƒãƒˆã€‚
- **Backup System**: æˆ¦é—˜ä¸­(0.5ç§’æ¯)ã«ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã¨åº§æ¨™ã‚’ `COMBAT_LOG_CACHE` ã«ä¿å­˜ã€‚
- **Disconnect Penalty**:
    - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¤œçŸ¥(`afterEvents.playerLeave`)æ™‚ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°Soulã‚’ç”Ÿæˆã—ã€ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«å‡¦åˆ‘ãƒ•ãƒ©ã‚°(`combat_log:<id>`)ã‚’ä¿å­˜ã€‚
    - æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚(`playerSpawn`)ã€ãƒ•ãƒ©ã‚°ãŒã‚ã‚Œã°ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå…¨æ²¡åï¼†3ç§’å¾Œã«å‡¦åˆ‘ã€‚

### D. Death Mechanics (Soul)
- **Keep Inventory**: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«ã§ONã«ã™ã‚‹ï¼ˆæ•£ã‚‰ã°ã‚Šé˜²æ­¢ï¼‰ã€‚
- **Partial Drop**:
    - **Hotbar (0-8), Armor, Offhand**: ãƒ‰ãƒ­ãƒƒãƒ—ã—ãªã„ï¼ˆç¢ºå®šã‚­ãƒ¼ãƒ—ï¼‰ã€‚
    - **Inventory (9-35)**: å„ã‚¢ã‚¤ãƒ†ãƒ ã”ã¨ã«ç¢ºç‡ã§æŠ½é¸ã€‚
        - å½“é¸ -> Soulã«ç§»å‹•ï¼ˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤ï¼‰ã€‚
        - è½é¸ -> æ‰‹å…ƒã«æ®‹ã‚‹ã€‚
    - Soulç”Ÿæˆä½ç½®ã¯ `y + 1.0`ã€‚

## 4. Current Mechanics / ç¾åœ¨ã®ä»•æ§˜

### Stats & Progression
- **Max Level**: 20 (Total 300 pts).
- **Stats**: 14 types (Max 100). Used for requirements.
- **Ether**: Regens 10% of rate every 0.1s.

### Economy
- **Currency**: Gold (`deepcraft:gold`).
- **Market**: Global listing via chunked dynamic properties.
  - Selling: Hand-held item only.
  - Buying: Menu UI.

### Content Data
- **Equipment**: `equipment.js` (atk, def, req, skill).
- **Talents**: `talents.js` (conditions, passive effects).
- **Bosses**: `mobs.js` (AI skills, HP bar on NameTag).

==========================================================================
*/

/*
==========================================================================
## 5. ğŸ“‚ File Structure & Roles (ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨å½¹å‰²)
==========================================================================

### /scripts/
  - **main.js**:
    - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‚
    - å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ`playerSpawn`, `entityHurt`ãªã©ï¼‰ã‚’è³¼èª­ï¼ˆsubscribeï¼‰ã—ã€å¯¾å¿œã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©é–¢æ•°ã«å‡¦ç†ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹ã€‚
    - ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã™ã‚‹ã€‚

### /scripts/data/
  - **equipment.js**: ã‚«ã‚¹ã‚¿ãƒ è£…å‚™ï¼ˆæ­¦å™¨ã€é˜²å…·ï¼‰ã®æ€§èƒ½ã‚„è¦æ±‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚
  - **mobs.js**: ã‚«ã‚¹ã‚¿ãƒ Mobï¼ˆãƒœã‚¹ã€ã‚´ãƒ–ãƒªãƒ³ãªã©ï¼‰ã®ä½“åŠ›ã€è£…å‚™ã€ãƒ‰ãƒ­ãƒƒãƒ—å“ã€ä½¿ç”¨ã‚¹ã‚­ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚
  - **market.js**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ¼ã‚±ãƒƒãƒˆã®å‡ºå“ã€è³¼å…¥ã€ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…ã†ã€‚
  - **quests.js**: ã‚¯ã‚¨ã‚¹ãƒˆã®ç›®æ¨™ã‚„å ±é…¬ã‚’å®šç¾©ã™ã‚‹ã€‚
  - **skills.js**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ«ã®åŠ¹æœã‚„ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å®šç¾©ã™ã‚‹ã€‚
  - **talents.js**: ãƒ‘ãƒƒã‚·ãƒ–ã‚¹ã‚­ãƒ«ï¼ˆã‚¿ãƒ¬ãƒ³ãƒˆï¼‰ã®åŠ¹æœã‚„æŠ½é¸æ¡ä»¶ã‚’å®šç¾©ã™ã‚‹ã€‚

### /scripts/player/
  - **player_manager.js**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸåŒ–ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã€XPç®¡ç†ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜/èª­è¾¼ãªã©ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¸­æ ¸ã‚’ç®¡ç†ã™ã‚‹ã€‚
  - **quest_manager.js**: ã‚¯ã‚¨ã‚¹ãƒˆã®å—æ³¨ã‚„å ±é…¬å—ã‘å–ã‚Šã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…ã†ã€‚
  - **skill_manager.js**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ã‚­ãƒ«ã®ä½¿ç”¨ã€ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†ã‚’è¡Œã†ã€‚
  - **stat_calculator.js**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚„Mobã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ”»æ’ƒåŠ›ã€é˜²å¾¡åŠ›ã€HPãªã©ï¼‰ã‚’ã€ãƒ¬ãƒ™ãƒ«ã‚„è£…å‚™ã€ã‚¿ãƒ¬ãƒ³ãƒˆã«åŸºã¥ã„ã¦è¨ˆç®—ã™ã‚‹ã€‚

### /scripts/systems/
  - **command_handler.js**: `/scriptevent` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã‚’æ‹…ã†ã€‚
  - **game_loop.js**: 0.5ç§’ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HUDè¡¨ç¤ºã€Mobã®AIã€æ­»äº¡å‡¦ç†ãªã©ã‚’å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ã€‚
  - **item_handler.js**: ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ãƒ†ãƒ ã®ç”Ÿæˆã€ã‚«ã‚¹ã‚¿ãƒ Mobã®å¬å–šãªã©ã€ã‚¢ã‚¤ãƒ†ãƒ ã‚„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ“ä½œã«é–¢ã™ã‚‹å‡¦ç†ã‚’æ‹…ã†ã€‚

### /scripts/combat/
  - **combat_system.js**: ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã®ä¸­æ ¸ã€‚æ”»æ’ƒåŠ›ã€é˜²å¾¡åŠ›ã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€å›é¿ãªã©ã‚’è¨ˆç®—ã—ã€ä»®æƒ³HPã«åæ˜ ã•ã›ã‚‹ã€‚
  - **death_system.js**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ­»äº¡ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ã€‚ä¸»ã«ãƒ‰ãƒ­ãƒƒãƒ—å“ã®ç”Ÿæˆã‚„ã€ã‚³ãƒ³ãƒãƒƒãƒˆãƒ­ã‚°ï¼ˆæˆ¦é—˜ä¸­ã®åˆ‡æ–­ï¼‰ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’æ‹…ã†ã€‚

### /scripts/ui/
  - **ui_manager.js**: `ChestFormData` ã‚’ä½¿ç”¨ã—ãŸå„ç¨®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã€ã‚¿ãƒ¬ãƒ³ãƒˆé¸æŠãªã©ï¼‰ã®è¡¨ç¤ºã¨æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…ã†ã€‚
*/